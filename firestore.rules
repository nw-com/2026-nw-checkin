rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isLoggedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return isLoggedIn() && request.auth.uid == uid;
    }

    // 認定「系統管理員」角色可管理後台資料
    function isAdmin() {
      return isLoggedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "系統管理員";
    }

    // 使用者資料：可讀（登入），建立/刪除（管理員），本人更新但不可改變角色
    match /users/{uid} {
      allow read: if isLoggedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() || (isSelf(uid) && request.resource.data.role == resource.data.role);
      allow delete: if isAdmin();
    }

    // 後台管理資料：僅管理員可寫入；登入者可讀取
    match /companies/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    match /regions/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    match /licenses/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    match /communities/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    // 打卡紀錄：登入者可讀與建立，更新/刪除限管理員或本人
    match /checkins/{docId} {
      allow read: if isLoggedIn();
      allow create: if isLoggedIn();
      allow update, delete: if isAdmin() || (isLoggedIn() && resource.data.userId == request.auth.uid);
    }
  }
}