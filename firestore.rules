rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isLoggedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return isLoggedIn() && request.auth.uid == uid;
    }

    // 認定「系統管理員」角色可管理後台資料
    function isAdmin() {
      return isLoggedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "系統管理員";
    }

    // 使用者資料：可讀（登入），建立/刪除（管理員），本人更新但不可改變角色
    match /users/{uid} {
      allow read: if isLoggedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() || (isSelf(uid) && request.resource.data.role == resource.data.role);
      allow delete: if isAdmin();
    }

    // 後台管理資料：僅管理員可寫入；登入者可讀取
    match /companies/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    match /regions/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    match /licenses/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    match /communities/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    // 打卡紀錄：登入者可讀與建立，更新/刪除限管理員或本人
    match /checkins/{docId} {
      allow read: if isLoggedIn() && resource.data.uid == request.auth.uid;
      allow create: if isLoggedIn() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isAdmin() || (isLoggedIn() && resource.data.uid == request.auth.uid);
    }

    // 帳號申請：任何人可提交；僅管理員可讀取/修改/刪除
    match /pendingAccounts/{docId} {
      allow create: if
        request.resource.data.keys().hasOnly([
          'photoUrl','name','title','email','phone','licenses','role',
          'companyId','serviceCommunities','pagePermissions','status','createdAt'
        ]) &&
        (request.resource.data.photoUrl == null || request.resource.data.photoUrl is string) &&
        request.resource.data.name is string &&
        (request.resource.data.title == null || request.resource.data.title is string) &&
        request.resource.data.email is string &&
        (request.resource.data.phone == null || request.resource.data.phone is string) &&
        (request.resource.data.licenses == null || request.resource.data.licenses is list) &&
        (request.resource.data.companyId == null || request.resource.data.companyId is string) &&
        (request.resource.data.serviceCommunities == null || request.resource.data.serviceCommunities is list) &&
        (request.resource.data.pagePermissions == null || request.resource.data.pagePermissions is list) &&
        request.resource.data.role == '一般' &&
        request.resource.data.status == '待審核' &&
        request.resource.data.createdAt is timestamp;

      allow read: if isAdmin();
      allow update, delete: if isAdmin();
    }
  }
}